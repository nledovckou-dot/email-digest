name: Deploy Email Digest

on:
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        env:
          REPO_URL: https://x-access-token:${{ github.token }}@github.com/${{ github.repository }}.git
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT }}
          command_timeout: 5m
          envs: REPO_URL
          script: |
            set -e
            mkdir -p /opt/email-digest
            cd /opt/email-digest
            if [ ! -d ".git" ]; then
              git init -b main
            fi
            git remote set-url origin "$REPO_URL" 2>/dev/null || git remote add origin "$REPO_URL"
            git fetch origin main
            git reset --hard origin/main

            # Python venv
            if [ ! -d ".venv" ]; then
              python3 -m venv .venv
            fi
            .venv/bin/pip install -q openpyxl python-dotenv

            # .env (idempotent â€” overwrite each deploy)
            touch .env
            _env_set() { sed -i "/^${1}=/d" .env; echo "${1}=${2}" >> .env; }
            _env_set GMAIL_USER "nledovckou@gmail.com"
            _env_set GMAIL_APP_PASSWORD "${{ secrets.GMAIL_APP_PASSWORD }}"
            _env_set TELEGRAM_BOT_TOKEN "${{ secrets.EMAIL_DIGEST_BOT_TOKEN }}"
            _env_set TELEGRAM_CHAT_ID "-5191768983"
            _env_set OPENAI_API_KEY "${{ secrets.OPENAI_API_KEY }}"

            # Ensure cron daemon is running
            echo "=== Cron service status ==="
            systemctl is-active cron 2>/dev/null || service cron status 2>/dev/null || echo "cron service not found"
            systemctl start cron 2>/dev/null || service cron start 2>/dev/null || echo "Could not start cron"
            systemctl enable cron 2>/dev/null || true

            # Systemd timer (reliable alternative to crontab)
            cat > /etc/systemd/system/email-digest.service <<'UNIT'
            [Unit]
            Description=Email Digest Bot
            After=network-online.target
            Wants=network-online.target

            [Service]
            Type=oneshot
            WorkingDirectory=/opt/email-digest
            ExecStart=/opt/email-digest/.venv/bin/python main.py
            StandardOutput=append:/opt/email-digest/run.log
            StandardError=append:/opt/email-digest/run.log
            UNIT

            cat > /etc/systemd/system/email-digest.timer <<'UNIT'
            [Unit]
            Description=Run Email Digest every 6h (06:00, 12:00, 18:00 MSK)

            [Timer]
            OnCalendar=*-*-* 03,09,15:00:00 UTC
            Persistent=true

            [Install]
            WantedBy=timers.target
            UNIT

            systemctl daemon-reload
            systemctl enable email-digest.timer
            systemctl start email-digest.timer

            # Also try crontab as backup
            CRON_LINE="0 3,9,15 * * * cd /opt/email-digest && .venv/bin/python main.py >> /opt/email-digest/cron.log 2>&1"
            (crontab -l 2>/dev/null | grep -v "email-digest"; echo "$CRON_LINE") | crontab -

            # Verify
            echo "=== Verify crontab ==="
            crontab -l 2>&1 || echo "crontab empty"

            echo "=== Verify systemd timer ==="
            systemctl list-timers email-digest.timer --no-pager 2>&1

            # Test run
            echo "=== Test run ==="
            .venv/bin/python main.py 2>&1 | tail -5

            echo "=== DEPLOY COMPLETE ==="
